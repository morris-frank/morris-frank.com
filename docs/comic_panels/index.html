<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#a9384a">
    <meta name="referrer" content="no-referrer">
    <meta name="description"
        name="The personal website of Maurice Frank. Information about my work, music and services.">
    <meta property="og:image" content="/icon.png" />

    
    
    <link rel="stylesheet" href="https://morris-frank.dev/sass/main.d0b4c698666d0b36d7f7e0c6a249bc445e1ee54dafc24a57635397dce7d08b09.css">
    <link rel="shortcut icon" type="image/png" href="/icon.png" />

    
    <script async src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.3.1/dist/lazyload.min.js"></script>

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.3/dist/katex.min.css"
        integrity="sha384-ThssJ7YtjywV52Gj4JE/1SQEDoMEckXyhkFVwaf4nDSm5OBlXeedVYjuuUd0Yua+" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.3/dist/katex.min.js"
        integrity="sha384-Bi8OWqMXO1ta+a4EPkZv7bYGIes7C3krGSZoTGNTAnAn5eYQc7IIXrJ/7ck1drAi"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.3/dist/contrib/auto-render.min.js"
        integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha256-BPfK9M5v34c2XP6p0cxVz1mUQLst0gTLk0mlc7kuodA=" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha256-yDc0eil8GjWFKqN1OSzHSVCiuGghTosZCcRje4tj7iQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js" crossorigin="anonymous"></script>

    <title> Extract panels from comic pages - Morris-Frank </title>
</head>

<body>
    <header class="center">
        <h1>
            <a href="https://morris-frank.dev">Morris-Frank</a>
        </h1>
        <a href="https://morris-frank.dev/projects">projects</a>
        <a href="https://morris-frank.dev/tutorials">tutorials</a>
        <a href="https://github.com/morris-frank/resume/raw/master/Frank_cv.pdf">cv</a>
        <a href="https://morris-frank.dev/services">hire me</a>
    </header>

    <nav id="toc"></nav>

    <main class="center">
        <h2>Extract panels from comic pages</h2>


<p>How to extract the individual panels from a scanned page from a comic book.</p>


<hr/>


<div class="tags">
  
    
    <span>Computer Vision</span>
  
</div>


<p>Today some classical computer vision with OpenCV. I needed a dataset of individual comic book panels for some model fine-tuning.</p>
<p>For example, take this page from an &ldquo;Astérix&rdquo; comic book:</p>
<p><img src="page.jpg" alt="The original page"></p>
<p>After counting, we see, it contains 11 individual panels and we will extract those with a little list of OpenCV magic.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="nn">cv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">file</span> <span class="o">=</span> <span class="s2">&#34;page.jpg&#34;</span>
<span class="n">orignal_img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">orignal_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div><h3 id="grayscale">Grayscale</h3>
<p>First, convert it to grayscale. Color is just confusing-</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">orignal_img</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&#34;bw.jpg&#34;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> 
</code></pre></div><p><img src="bw.jpg" alt="After making it grayscale"></p>
<h3 id="blurring">Blurring</h3>
<p>To get rid of the fine features, apply some median blurring.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">medianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&#34;blur.jpg&#34;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> 
</code></pre></div><p><img src="blur.jpg" alt="After blurring"></p>
<h3 id="sharpening">Sharpening</h3>
<p>Next, re-sharpen the panel edges. Use the basic classical sharpening kernel.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                   <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">filter2D</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">ddepth</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">)</span>
<span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&#34;sharpen.jpg&#34;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> 
</code></pre></div><p><img src="sharpen.jpg" alt="After sharpening"></p>
<h3 id="thresholding">Thresholding</h3>
<p>Time to go to binary. For this use <a href="https://en.wikipedia.org/wiki/Otsu%27s_method">Otsu&rsquo;s method</a> for thresholding. Looks already good, but we want to fille the white patterns in the panels as well as possible to make the contour detection easier.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">_</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">THRESH_BINARY</span> <span class="o">+</span> <span class="n">cv</span><span class="o">.</span><span class="n">THRESH_OTSU</span><span class="p">)</span>
<span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&#34;otsu.jpg&#34;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> 
</code></pre></div><p><img src="otsu.jpg" alt="After applying otsu thresholding"></p>
<h3 id="opening">Opening</h3>
<p>To <em>paint over</em> the little white features, apply a <a href="https://en.wikipedia.org/wiki/Opening_(morphology)">open up</a> the binary mask. Now looks really black already!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">morphologyEx</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">MORPH_OPEN</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
<span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&#34;open.jpg&#34;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> 
</code></pre></div><p><img src="open.jpg" alt="After opening up"></p>
<h3 id="flood-fill">Flood-fill</h3>
<p>Finally, to fill the remaining white holes in the black panels, apply a flood-fill filter. As we see, except for two of the panels its returning perfect black rectangles. Having some remaining white holes is fine though, as we regularize the contour detection which smooth over it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">floodFill</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">height</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">width</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="s2">&#34;floodfill.jpg&#34;</span><span class="p">,</span> <span class="n">img</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> 
</code></pre></div><p><img src="floodfill.jpg" alt="After flood-filling"></p>
<h3 id="contour-extraction">Contour extraction</h3>
<p>The <code>cv.findContours</code> method from OpenCV generally finds contours of objects in images. With the pre-processing we made sure that the only sensible objects remaining should be the panels. Nevertheless we filter the found countours by their size with a minimum area and a maximum area.</p>
<p>The contours found will not be perfect four-edge rectangles, therefore we apply <code>cv.boundingRect</code> which will fit a rectangle around the contour. This will almost be the same contour but we need the simple <em>x,y, width, height</em> rectangle to select from the original image.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py3" data-lang="py3"><span class="n">contours</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">RETR_TREE</span><span class="p">,</span> <span class="n">cv</span><span class="o">.</span><span class="n">CHAIN_APPROX_SIMPLE</span><span class="p">)</span>
<span class="n">min_size</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># 1% minimum size</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="n">contours</span><span class="p">:</span>
    <span class="k">if</span>  <span class="n">min_size</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">cv</span><span class="o">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">cv</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
        <span class="n">panel</span> <span class="o">=</span> <span class="n">orignal_img</span><span class="p">[</span><span class="n">y</span><span class="p">:</span><span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">+</span><span class="n">w</span><span class="p">]</span>
        <span class="n">cv</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;panel_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">.jpg&#34;</span><span class="p">,</span> <span class="n">panel</span><span class="p">)</span> 
</code></pre></div><p>This will extract the panels looking like this:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="panel_01.jpg" alt=""></td>
<td><img src="panel_02.jpg" alt=""></td>
<td><img src="panel_03.jpg" alt=""></td>
<td><img src="panel_04.jpg" alt=""></td>
</tr>
<tr>
<td><img src="panel_05.jpg" alt=""></td>
<td><img src="panel_06.jpg" alt=""></td>
<td><img src="panel_07.jpg" alt=""></td>
<td><img src="panel_08.jpg" alt=""></td>
</tr>
<tr>
<td><img src="panel_09.jpg" alt=""></td>
<td><img src="panel_10.jpg" alt=""></td>
<td><img src="panel_11.jpg" alt=""></td>
<td></td>
</tr>
</tbody>
</table>
<p>Pretty good eh! And so easy!</p>
<h3 id="bonus-extract-text">Bonus: extract text</h3>
<p>As a bonus, we extract the text from the saved panels with <a href="https://github.com/madmaze/pytesseract">Python Tesseract</a>.
You might have noticed, that the given comic is in Russian. Therefore when installing Google&rsquo;s <a href="https://github.com/tesseract-ocr/tesseract">Tesseract OCR</a> you also have to install the extended language packs to also recognize Russian.</p>
<p>With Tesseract installed, getting the text from the images is easy:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="n">texts</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">):</span>
    <span class="c1"># Do OCR with tesseract</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">pytesseract</span><span class="o">.</span><span class="n">image_to_string</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;panel_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">02</span><span class="si">}</span><span class="s2">.jpg&#34;</span><span class="p">),</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&#34;rus&#34;</span><span class="p">,</span> <span class="n">nice</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Remove new-lines, make lower-case and clean white-spaces</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34; &#34;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># Reduce to only word-characters</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^\w ]+&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="c1"># Reduce multiple spaces in the text to single space</span>
    <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="n">texts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>
</code></pre></div><p>Sadly, the images are rather small and the text is not super-readable. Therefore for this page, Tesseract only recognizes the text in 5 out of the 11 panels:</p>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>чуть позже это мой поларок америксу небольшой знак зачем ты внимания аля укрепления ташишь с дружбы с0бой этот менгир</td>
<td></td>
<td>атеперь я спою вам прошальную</td>
<td></td>
</tr>
<tr>
<td>именем тевтатеса можешь на нас расчитывать вожль жизнестатистикс</td>
<td>сейчас сообшу всем</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>слишком опасно 3 3 2 8 5</td>
<td>спасибо за предложение астерикс но я не могу тебе этого позволить</td>
<td></td>
</tr>
</tbody>
</table>

    </main>

    <footer>
        <div class="center box flex">
            <div>
                <h2>Contact</h2>
                <p>Maurice Frank</p>
                <p class="icon-mail-alt">firstname.lastname @ posteo de</p>
                <p class="icon-code"><a href="https://github.com/morris-frank/morris-frank.dev">source code (MIT)</a>
                </p>
            </div>
            <div>
                <h2>Privacy statement</h2>
                <p>I don't collect any data from you. Neither do I want any data. So don't send me any!</p>
            </div>
        </div>
    </footer>

    <script> window.addEventListener('load', function () { var lazyLoadInstance = new LazyLoad({}); }, false);</script>
    <script>
        const toc_items = document.querySelectorAll("h3");
        if (toc_items.length > 0) {
            let inner = "<ul>";
            toc_items.forEach(item => {
                inner += "<li><a href=\"#" + item.id + "\">" + item.innerText + "</a></li>";
            });
            toc.innerHTML = inner + "</ul>";
        }
    </script>

</body>

</html>